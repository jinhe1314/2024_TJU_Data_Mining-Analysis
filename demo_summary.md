# 血糖预测模型Demo总结

## 概述

本项目创建了3个演示程序，使用3个不同的模型对患者 **2035_0_20210629** 的血糖数据进行预测。

- **测试患者**: 2035_0_20210629 (T2DM患者)
- **输入数据**: 前9个时间点的历史数据（实际使用前10个数据点作为模型输入）
- **预测目标**: 未来15分钟、30分钟、45分钟、60分钟的血糖值
- **可视化**: 9个历史数据点 + 4个预测数据点 = 13个节点的血糖曲线图

---

## Demo文件清单

| Demo | 脚本文件 | 使用模型 | 输出图片 |
|------|---------|---------|---------|
| Demo 1 | `demo1_gcm_model.py` | GCM_model.h5 | demo1_prediction_GCM_model.png |
| Demo 2 | `demo2_gcm_model_tf213.py` | GCM_model_tf213_new.h5 | demo2_prediction_GCM_model_tf213.png |
| Demo 3 | `demo3_tflite_model.py` | glucose_predictor.tflite | demo3_prediction_tflite.png |

---

## 患者数据信息

### 基本信息
- **患者ID**: 2035_0_20210629
- **数据类型**: 上海T2DM数据集
- **总数据点**: 240个时间点
- **时间间隔**: 15分钟/次
- **测试时间范围**: 2021-06-29 17:04:00 → 2021-06-29 19:04:00

### 前9个时间点的血糖值

| 时间点 | 时间 | CGM血糖值 (mg/dL) |
|--------|------|------------------|
| 0 | 17:04 | 142.2 |
| 1 | 17:19 | 158.4 |
| 2 | 17:34 | 172.8 |
| 3 | 17:49 | 172.8 |
| 4 | 18:04 | 172.8 |
| 5 | 18:19 | 172.8 |
| 6 | 18:34 | 172.8 |
| 7 | 18:49 | 165.6 |
| 8 | 19:04 | 153.0 |

**趋势**: 血糖从142.2上升至172.8后维持高位，然后开始下降至153.0

---

## 预测结果对比

### 各模型预测结果

| 时间点 | Demo 1<br>GCM_model.h5 | Demo 2<br>GCM_model_tf213_new.h5 | Demo 3<br>glucose_predictor.tflite |
|--------|----------------------|--------------------------------|-----------------------------------|
| **15分钟后** (19:19) | 133.50 mg/dL | 144.84 mg/dL | 134.86 mg/dL |
| **30分钟后** (19:34) | 127.96 mg/dL | 138.76 mg/dL | 129.43 mg/dL |
| **45分钟后** (19:49) | 122.51 mg/dL | 133.48 mg/dL | 123.82 mg/dL |
| **60分钟后** (20:04) | 118.13 mg/dL | 128.50 mg/dL | 119.47 mg/dL |

### 预测趋势分析

所有3个模型都预测血糖会持续下降：

1. **GCM_model.h5** (Demo 1):
   - 预测下降最快: 153.0 → 118.13 (下降34.87 mg/dL)
   - 60分钟后预测最低: 118.13 mg/dL

2. **GCM_model_tf213_new.h5** (Demo 2):
   - 预测下降最慢: 153.0 → 128.50 (下降24.50 mg/dL)
   - 60分钟后预测最高: 128.50 mg/dL
   - 相对更保守的预测

3. **glucose_predictor.tflite** (Demo 3):
   - 预测趋势居中: 153.0 → 119.47 (下降33.53 mg/dL)
   - 与Demo 1非常接近（差异<2 mg/dL）

### 模型对比

| 模型特性 | Demo 1 | Demo 2 | Demo 3 |
|---------|--------|--------|--------|
| 模型格式 | Keras H5 | Keras H5 | TensorFlow Lite |
| 文件大小 | 1.9 MB | 1.9 MB | 202 KB |
| 推理速度 | ~2秒 | ~2秒 | <1秒 (估计) |
| 适用平台 | 服务器/桌面 | 服务器/桌面 | 移动端/嵌入式 |
| 预测风格 | 积极下降 | 保守稳定 | 积极下降 |

---

## 运行方法

### 环境要求

```bash
# 安装依赖
pip install tensorflow==2.13.0
pip install numpy==1.24.3
pip install pandas
pip install matplotlib
pip install scikit-learn
```

### 运行Demo

```bash
# Demo 1 - 使用GCM_model.h5
python demo1_gcm_model.py

# Demo 2 - 使用GCM_model_tf213_new.h5
python demo2_gcm_model_tf213.py

# Demo 3 - 使用glucose_predictor.tflite
python demo3_tflite_model.py
```

每个demo会：
1. 自动加载患者数据
2. 重建scalers（标准化器）
3. 加载对应模型
4. 进行预测
5. 生成可视化图表并保存为PNG文件

---

## Demo实现特点

### 1. 数据预处理
- 自动加载所有121个患者的训练数据
- 重建StandardScaler以确保与训练时一致
- 提取时序特征（51个）和静态特征（30个）

### 2. 序列构建
- 使用10个时间步作为输入窗口（150分钟历史数据）
- 时序输入形状: (1, 10, 51)
- 静态输入形状: (1, 30)

### 3. 模型推理
- **Keras模型**: 使用 `model.predict([ts_X, static_X])`
- **TFLite模型**: 使用 `interpreter.invoke()`
- 预测结果反标准化恢复原始血糖值

### 4. 可视化设计
- 蓝色圆点: 历史血糖值（9个点）
- 红色方块: 预测血糖值（4个点）
- 绿色阴影: 正常血糖范围 (70-180 mg/dL)
- 数值标签: 每个点显示精确血糖值
- X轴: 时间（分钟）
- Y轴: 血糖水平 (mg/dL)

---

## 关键发现

### 1. 模型一致性
- Demo 1 和 Demo 3 预测结果非常接近（TFLite是从原始模型转换的）
- Demo 2 (TF2.13新模型) 预测较为保守，可能使用了不同的训练配置

### 2. 临床意义
- 所有模型都预测血糖持续下降
- 60分钟后预测值均在正常范围内（70-180 mg/dL）
- 无低血糖风险警告（所有预测值 > 100 mg/dL）

### 3. 模型性能
- TFLite模型大小仅为原始模型的10%（202KB vs 1.9MB）
- TFLite模型精度与原始模型几乎一致
- 适合移动端部署

---

## 可视化示例说明

每个demo生成的PNG图表包含：

```
Blood Glucose Prediction - Patient 2035_0_20210629
Model: [模型名称]

[图表]
- 时间轴: 0, 15, 30, 45, 60, 75, 90, 105, 120 (历史)
         135, 150, 165, 180 (预测)
- Y轴: 血糖值 80-180 mg/dL
- 绿色背景: 正常范围 (70-180)
- 蓝色折线: 历史数据
- 红色折线: 预测数据
```

---

## 技术细节

### 模型架构
```
输入:
├─ 时序数据: (batch, 10, 51) - 10个时间步 × 51个时序特征
└─ 静态数据: (batch, 30) - 30个患者特征

网络:
├─ LSTM编码器: 64→56→48→40→36→32
├─ Dense编码器: 64→56→48→40→36→32
├─ 交叉注意力: 双向注意力机制
└─ 解码器: 64→16→4

输出: (batch, 4) - [15min, 30min, 45min, 60min] 血糖预测值
```

### 数据标准化
```python
# 3个独立的StandardScaler
scaler_ts_X      # 时序特征标准化
scaler_static_X  # 静态特征标准化
scaler_y         # 目标值标准化

# 预测后需要反标准化
y_pred = scaler_y.inverse_transform(y_pred_scaled)
```

---

## 文件输出

每个demo生成以下文件：

| 文件 | 说明 | 大小 |
|------|------|------|
| `demo1_prediction_GCM_model.png` | Demo 1预测图表 | ~216 KB |
| `demo2_prediction_GCM_model_tf213.png` | Demo 2预测图表 | ~225 KB |
| `demo3_prediction_tflite.png` | Demo 3预测图表 | ~223 KB |

---

## 总结

这3个demo成功展示了：
1. ✅ 从历史数据进行血糖预测
2. ✅ 多个模型的预测结果对比
3. ✅ TFLite模型在移动端的应用潜力
4. ✅ 完整的数据预处理→模型推理→可视化流程
5. ✅ 9个历史点 + 4个预测点的血糖曲线图

所有模型都表现出良好的预测能力，能够捕捉血糖的下降趋势，为糖尿病患者的血糖管理提供有价值的参考。

---

**创建时间**: 2024-12-08
**测试患者**: 2035_0_20210629 (上海T2DM数据集)
**预测时间跨度**: 60分钟
**预测间隔**: 15分钟
